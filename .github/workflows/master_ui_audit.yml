name: üèÜ Master UI & Chaos Audit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permette di avviarlo manualmente

jobs:
  ui-chaos-certification:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üñ•Ô∏è Installa Monitor Virtuale (Xvfb & Dipendenze Qt)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 libxcb-shape0 libegl1 libgl1 libxcb-cursor0

      - name: üì¶ Installa Dipendenze Python
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-qt psutil
          playwright install chromium

      - name: üé® 1. MASTER UI TEST (Test Interfaccia con Pytest-Qt)
        # xvfb-run crea lo schermo virtuale dove PySide6 andr√† a "disegnare" la UI
        env:
          PYTHONPATH: .
        run: xvfb-run --auto-servernum python -m pytest tests/tests/ui/MASTER_UI_TEST.py -v

      - name: üî• 2. REAL ATTACK TEST (Chaos Engineering)
        env:
          PYTHONPATH: .
        run: python -m tests.tests.system_integrity.REAL_ATTACK_TEST

      - name: üß† 3. MINI-SOAK TEST (Stress Test RAM)
        # NOTA: Su GitHub Actions c'√® un limite di 6 ore per i job gratuiti.
        # Il test durer√† 2 minuti come impostato di default nello script per verificare memory leak istantanei.
        env:
          PYTHONPATH: .
        run: python -m tests.tests.system_integrity.SOAK_24H_TEST
