name: üïµÔ∏è‚Äç‚ôÇÔ∏è Anti-Detect Security Check (Ghost Mode)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'

jobs:
  stealth-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del codice repository
      uses: actions/checkout@v4
      
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Installazione Dipendenze
      run: |
        python -m pip install --upgrade pip
        pip install playwright pytest requests
        
    - name: Installazione Motore Chromium C++
      run: python -m playwright install chromium --with-deps
      
    - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Esecuzione Ultimate Anti-Detect Audit
      env:
        # Passiamo il Token Webshare
        WEBSHARE_TOKEN: ${{ secrets.WEBSHARE_TOKEN }}
      run: |
        echo "üîÑ Creazione script Python per estrazione proxy..."
        
        # Scrive un file python al volo per evitare qualsiasi errore di sintassi Bash
        cat << 'EOF' > get_proxy.py
        import os, sys, requests
        token = os.getenv('WEBSHARE_TOKEN')
        
        if not token:
            print('‚ùå ERRORE: WEBSHARE_TOKEN √® vuoto. Controlla i Secrets!', file=sys.stderr)
            sys.exit(0)
            
        try:
            # FIX 1: Modalit√† "backbone" richiesta per i proxy residenziali
            url = 'https://proxy.webshare.io/api/v2/proxy/list/?mode=backbone&page=1&page_size=100'
            headers = {'Authorization': f'Token {token}'}
            r = requests.get(url, headers=headers, timeout=15)
            
            if r.status_code != 200:
                print(f'‚ùå ERRORE API WEBSHARE (HTTP {r.status_code}): {r.text}', file=sys.stderr)
                sys.exit(0)
                
            proxies = r.json().get('results', [])
            it_proxies = [x for x in proxies if x.get('country_code') == 'IT' and x.get('valid')]
            
            if not it_proxies:
                print('‚ùå ERRORE: Nessun proxy IT valido trovato.', file=sys.stderr)
                sys.exit(0)
                
            p = it_proxies[0]
            # Stampa il risultato pulito
            print(f"http://{p['username']}:{p['password']}@{p['proxy_address']}:{p['port']}")
            
        except Exception as e:
            print(f'‚ùå ERRORE DI RETE PYTHON: {str(e)}', file=sys.stderr)
        EOF

        echo "üîÑ Interrogazione API Webshare in corso..."
        # FIX 2: Esegue il file appena creato e cattura il proxy
        export PROXY_URL=$(python get_proxy.py)

        if [ -z "$PROXY_URL" ]; then
            echo "‚ö†Ô∏è Attenzione: Nessun proxy recuperato. Guarda l'errore ‚ùå qui sopra nei log."
        else
            # Nasconde la password dai log
            MASKED_URL=$(echo "$PROXY_URL" | sed -e 's/\(http:\/\/[^:]*:\)[^@]*\(@.*\)/\1***\2/')
            echo "‚úÖ Proxy Italiano estratto con successo: $MASKED_URL"
        fi

        echo "üöÄ Avvio dell'Audit Anti-Detect..."
        xvfb-run -a python -u tests/tests/system_integrity/ANTI_DETECT_AUDIT.py
