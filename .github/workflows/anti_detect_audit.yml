name: üïµÔ∏è‚Äç‚ôÇÔ∏è Anti-Detect Security Check (Ghost Mode)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'

jobs:
  stealth-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del codice repository
      uses: actions/checkout@v4
      
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Installazione Dipendenze (Playwright)
      run: |
        python -m pip install --upgrade pip
        pip install playwright pytest requests
        
    - name: Installazione Motore Chromium C++
      run: python -m playwright install chromium --with-deps
      
    - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Esecuzione Ultimate Anti-Detect Audit
      env:
        # Prende il link sicuro dai secrets di GitHub
        WEBSHARE_DOWNLOAD_URL: ${{ secrets.WEBSHARE_DOWNLOAD_URL }}
      run: |
        # Estraiamo e formattiamo il primo proxy italiano dalla tua lista Webshare
        export PROXY_URL=$(python -c "
        import os, requests
        url = os.getenv('WEBSHARE_DOWNLOAD_URL')
        if url:
            try:
                resp = requests.get(url, timeout=10)
                if resp.status_code == 200:
                    lines = resp.text.strip().split('\n')
                    if lines:
                        # Il formato Webshare TXT √® IP:PORTA:USER:PASS
                        parts = lines[0].strip().split(':')
                        if len(parts) >= 4:
                            ip, port, user, pw = parts[0], parts[1], parts[2], parts[3]
                            # Formattiamo per il tuo script: http://user:pass@ip:porta
                            print(f'http://{user}:{pw}@{ip}:{port}')
            except Exception as e:
                pass
        ")

        if [ -z "$PROXY_URL" ]; then
            echo "‚ö†Ô∏è Attenzione: Nessun proxy recuperato. Il test partir√† senza proxy."
        else
            echo "‚úÖ Proxy Italiano estratto con successo e iniettato nell'Audit!"
        fi

        # IL TUO FILE ORIGINALE RIPRENDE IL CONTROLLO QUI SOTTO:
        # xvfb-run emula un display X11 virtuale (fondamentale per ingannare i test anti-bot)
        xvfb-run -a python -u tests/tests/system_integrity/ANTI_DETECT_AUDIT.py
