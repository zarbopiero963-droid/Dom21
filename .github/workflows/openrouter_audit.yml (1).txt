name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'SHA del vecchio commit da controllare'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Extract Diff
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_SHA="${{ inputs.commit_sha }}"
            echo "üîß Manual Mode: $TARGET_SHA"
            git diff $TARGET_SHA^ $TARGET_SHA > commit_diff.txt
            echo "REVIEW_SHA=$TARGET_SHA" >> $GITHUB_ENV
          else
            echo "üöÄ Push Mode"
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
               git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER > commit_diff.txt
            else
               git diff $BEFORE $AFTER > commit_diff.txt
            fi
            echo "REVIEW_SHA=$AFTER" >> $GITHUB_ENV
          fi

      - name: AI Analysis (2026 Free Models Only)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import time

          # LISTA AGGIORNATA FEBBRAIO 2026 (Nomi esatti dal database OpenRouter)
          MODELS = [
              "openai/gpt-oss-120b:free",                 # Il nuovo standard gratuito di OpenAI
              "qwen/qwen-3-coder-480b-a35b-instruct:free", # Migliore per il codice (480B)
              "arcee-ai/trinity-large-preview:free",       # Altamente disponibile
              "meta-llama/llama-3.3-70b-instruct:free",    # Ottimo ma spesso 429
              "stepfun/step-3.5-flash:free"                # Fallback ultra-veloce
          ]
          
          api_key = os.environ.get("OPENROUTER_API_KEY")

          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()[:25000] # Limite per evitare payload troppo grandi
          except OSError:
            diff_content = ""

          if not diff_content.strip():
              print("Diff vuoto o errore lettura.")
              exit(0)

          prompt = f"Review questo git diff. Sii tecnico e breve. Usa Markdown.\n\n{diff_content}"
          success = False
          
          for model in MODELS:
              print(f"üîÑ Tentativo con {model}...")
              try:
                  response = requests.post(
                      url="https://openrouter.ai/api/v1/chat/completions",
                      headers={
                          "Authorization": f"Bearer {api_key}",
                          "HTTP-Referer": "https://github.com/v4-agent",
                          "Content-Type": "application/json"
                      },
                      json={
                          "model": model,
                          "messages": [{"role": "user", "content": prompt}]
                      },
                      timeout=40
                  )
                  
                  if response.status_code == 200:
                      report = response.json()["choices"][0]["message"]["content"]
                      with open("ai_report.md", "w", encoding="utf-8") as f:
                          f.write(f"### ü§ñ AI Review ({model})\n\n{report}")
                      
                      # Scrittura nel Riepilogo di GitHub
                      with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as f:
                          f.write(f"### ü§ñ AI Review ({model})\n\n{report}")
                      
                      print("‚úÖ Successo!")
                      success = True
                      break
                  elif response.status_code == 429:
                      print("‚è≥ Modello intasato (429), provo il prossimo...")
                      time.sleep(2)
                  else:
                      print(f"‚ùå Errore {response.status_code}: {response.text}")
              except Exception as e:
                  print(f"‚ö†Ô∏è Eccezione: {e}")

          if not success:
              with open("ai_report.md", "w") as f: f.write("### ‚ùå Errore\nTutti i modelli gratuiti sono offline.")
          '

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ai_report.md ]; then
            SHA="${{ env.REVIEW_SHA }}"
            gh api --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/commits/$SHA/comments \
              -F body=@ai_report.md || echo "Impossibile commentare (SHA non valido?)"
          fi
